map $http_x_request_id $req_id {
    default   $http_x_request_id;
    ""        $request_id;
}

log_format json_combined escape=json
    '{'
        '"time":"$time_iso8601",'
        '"request_id":"$req_id",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_user_agent":"$http_user_agent"'
    '}';

upstream identity_service {
    server identity:8000;
}

upstream discovery_service {
    server discovery:8000;
}

upstream pitch_service {
    server pitch:8000;
}

upstream payment_service {
    server payment:8000;
}

upstream ml_service {
    server ml:8000;
}

server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/access.log json_combined;
    error_log  /var/log/nginx/error.log warn;

    # --- CORS ---
    set $cors_origin "";
    if ($http_origin ~* "^https?://localhost(:[0-9]+)?$") {
        set $cors_origin $http_origin;
    }

    # --- Common proxy headers ---
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID      $req_id;

    proxy_pass_request_headers on;

    # Hide CORS headers from backend services (NGINX handles CORS)
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Max-Age;
    proxy_hide_header Vary;

    # --- Health check ---
    location /health {
        access_log off;
        return 200 '{"status":"ok","service":"gateway"}';
        add_header Content-Type application/json;
    }

    # --- Identity Service ---
    location /api/v1/auth/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://identity_service;
    }

    location /api/v1/users/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://identity_service;
    }

    location /api/v1/freelancers/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://identity_service;
    }

    location /api/v1/newsrooms/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://identity_service;
    }

    # --- Discovery Service ---
    location /api/v1/discovery/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://discovery_service;
    }

    location /api/v1/squads/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://discovery_service;
    }

    # --- Pitch Service ---
    location /api/v1/pitch-windows/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://pitch_service;
    }

    location /api/v1/pitches/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://pitch_service;
    }

    location /api/v1/assignments/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://pitch_service;
    }

    # --- Payment Service ---
    location /api/v1/payments/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://payment_service;
    }

    location /api/v1/compliance/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://payment_service;
    }

    location /api/v1/ledger/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://payment_service;
    }

    # --- ML Service ---
    location /api/v1/portfolio/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://ml_service;
    }

    location /api/v1/style/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://ml_service;
    }

    location /api/v1/duplicate/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://ml_service;
    }

    location /api/v1/trust-score/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_origin;
            add_header Access-Control-Allow-Credentials "true";
            add_header Access-Control-Allow-Methods     "GET, POST, PATCH, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers     "Content-Type, Authorization, X-Newsroom-ID, X-Request-ID";
            add_header Access-Control-Max-Age           86400;
            return 204;
        }
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_pass http://ml_service;
    }

    # --- Webhooks (no CORS needed) ---
    location /api/v1/webhooks/stripe {
        proxy_pass http://payment_service;
    }

    location /api/v1/webhooks/cms/ {
        proxy_pass http://pitch_service;
    }

    # --- Service health aggregation ---
    location /api/health {
        access_log off;
        return 200 '{"gateway":"ok"}';
        add_header Content-Type application/json;
    }
}
